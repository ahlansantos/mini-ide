<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Language Code Executor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://skulpt.org/js/skulpt.min.js" type="text/javascript"></script>
    <script src="https://skulpt.org/js/skulpt-stdlib.js" type="text/javascript"></script>
    <script src="https://unpkg.com/lua-js@latest/dist/lua.js"></script>
    <style>
        /* Custom styles to complement Tailwind and define base layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* slate-800 */
            color: #f8fafc; /* slate-50 */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            flex-grow: 1; /* Allow the main container to take up remaining space */
            display: flex;
            flex-direction: column;
        }
        /* Define minimum height for editor and output containers on smaller screens */
        .editor-container, .output-container {
             min-height: 300px; /* Minimum height to prevent collapse */
             display: flex; /* Use flexbox to align title and text area/pre */
             flex-direction: column; /* Stack title and area vertically */
        }
        #code-editor, #output-area {
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
            border: 1px solid #334155; /* slate-700 */
            border-radius: 0.375rem; /* rounded-md */
            flex-grow: 1; /* Allow editor/output to take up remaining space in its container */
            font-family: 'Courier New', Courier, monospace; /* Monospaced font for code */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.5; /* Line spacing */
            padding: 0.75rem; /* p-3 */
            resize: none; /* Prevent manual resizing of textarea */
            outline: none; /* Remove default outline on focus */
        }
         #output-area {
            color: #94a3b8; /* slate-400 */
            white-space: pre-wrap; /* Preserve spaces and wrap lines */
            word-wrap: break-word; /* Break long words */
            overflow-y: auto; /* Add vertical scrollbar */
        }
        .btn {
            transition: background-color 0.3s ease, opacity 0.3s ease; /* Add opacity transition */
        }
        .btn-primary {
            background-color: #2563eb; /* blue-600 */
            color: white;
        }
        .btn-primary:hover:not(:disabled) { /* Hover effect only if not disabled */
            background-color: #1d4ed8; /* blue-700 */
        }
         .btn-secondary {
            background-color: #475569; /* slate-600 */
            color: white;
        }
        .btn-secondary:hover:not(:disabled) { /* Hover effect only if not disabled */
            background-color: #334155; /* slate-700 */
        }
        .btn:disabled { /* Style for disabled button */
            opacity: 0.5;
            cursor: not-allowed;
        }
        .title-bar {
            background-color: #334155; /* slate-700 */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            font-weight: 500; /* medium */
            border-top-left-radius: 0.375rem; /* rounded-tl-md */
            border-top-right-radius: 0.375rem; /* rounded-tr-md */
            flex-shrink: 0; /* Prevent title bar from shrinking */
        }
        /* Scrollbar styling customization */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; /* slate-900 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        /* Style for the language select dropdown */
        #language-select {
            background-color: #334155; /* slate-700 */
            color: #f8fafc; /* slate-50 */
            border: 1px solid #475569; /* slate-600 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            outline: none;
            appearance: none; /* Remove default select arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2220%22%20height%3D%2220%22%20fill%3D%22%23f8fafc%22%20viewBox%3D%220%200%2020%2020%22%3E%3Cpath%20d%3D%22M5.293%207.293a1%201%200%20011.414%200L10%2010.586l3.293-3.293a1%201%200%20111.414%201.414l-4%204a1%201%200%2001-1.414%200l-4-4a1%201%200%20010-1.414z%22%2F%3E%3C%2Fsvg%3E'); /* Add custom arrow */
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em auto;
        }
        #language-select:hover {
             border-color: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 flex flex-col h-screen">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-extrabold text-slate-100 mb-2">Multi-Language Code Executor</h1>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                 <label for="language-select" class="text-slate-300 font-medium">Select Language:</label>
                 <select id="language-select">
                    <option value="python">Python (via Skulpt)</option>
                    <option value="lua">Lua (via Lua.js)</option>
                    </select>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow min-h-0">
            <div class="editor-container bg-slate-800 rounded-lg shadow-xl overflow-hidden">
                <div class="title-bar text-slate-200">
                    Code Editor (<span id="current-language-title">Python</span>)
                </div>
                <textarea id="code-editor"
                    placeholder="Enter your code here..."
                    class="w-full h-full"></textarea> </div>

            <div class="output-container bg-slate-800 rounded-lg shadow-xl overflow-hidden">
                 <div class="title-bar text-slate-200">
                    Output
                </div>
                <pre id="output-area" class="w-full h-full"></pre> </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
            <button id="run-button"
                class="btn btn-primary py-3 px-8 rounded-md font-semibold shadow-md hover:shadow-lg text-lg">
                Run Code
            </button>
            <button id="clear-output-button"
                class="btn btn-secondary py-3 px-8 rounded-md font-semibold shadow-md hover:shadow-lg text-lg">
                Clear Output
            </button>
        </div>

        <footer class="text-center text-sm text-slate-400 mt-8 pb-4">
            Simple multi-language code executor (Python via Skulpt, Lua via Lua.js). Language support is limited by the JavaScript/WebAssembly libraries used.
        </footer>
    </div>

    <script type="text/javascript">
        // Main object to manage the Multi-Language Executor
        const MultiLangExecutor = {
            // References to DOM elements
            codeEditor: document.getElementById('code-editor'),
            outputArea: document.getElementById('output-area'),
            runButton: document.getElementById('run-button'),
            clearOutputButton: document.getElementById('clear-output-button'),
            languageSelect: document.getElementById('language-select'),
            currentLanguageTitle: document.getElementById('current-language-title'),

            // Map of emojis for message types
            EMOJI_MAP: {
                log: 'üìù', // Generic log emoji
                python: 'üêç', // Python emoji
                lua: 'üåô', // Lua emoji (lua means moon in Portuguese)
                error: '‚ùå',
                warn: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                loading: '‚è≥' // Loading state emoji
            },

            // Example code for each language
            EXAMPLE_CODE: {
                python: `# Welcome to the Python Code Executor!
# Experiment with Python (limited by Skulpt).

def greet(name):
  return f"Hello, {name} from Python!"

user_name = "Skulpt User"
print(greet(user_name))

numbers = [1, 2, 3, 4, 5]
squares = [n*n for n in numbers]
print(f"Squares: {squares}")

# Try importing a supported module (e.g., math, random)
# import math
# print(f"Pi: {math.pi}")

# Errors will be caught:
# print(undefined_variable)
# result = 10 / 0
`,
                lua: `-- Welcome to the Lua Code Executor!
-- Experiment with Lua (limited by Lua.js).

function greet(name)
  return "Hello, "..name.." from Lua!"
end

user_name = "Lua.js User"
print(greet(user_name))

numbers = {1, 2, 3, 4, 5}
print("Numbers:")
for i, v in ipairs(numbers) do
  print(v)
end

-- Errors will be caught:
-- print(undefined_variable)
-- result = 10 / 0
`
            },

            // Current selected language state
            currentLanguage: 'python',
            luaState: null, // To maintain the state of the Lua interpreter

            /**
             * Adds a formatted message to the output area.
             * @param {string} message - The message to display.
             * @param {string} type - The message type ('log', 'error', 'warn', 'info', 'success', 'loading').
             * @param {string} lang - The language associated with the message (for specific emoji).
             */
            addToOutput(message, type = 'log', lang = null) {
                const emoji = lang ? (this.EMOJI_MAP[lang] || this.EMOJI_MAP.log) : (this.EMOJI_MAP[type] || this.EMOJI_MAP.log);
                const timestamp = new Date().toLocaleTimeString();
                const messageElement = document.createElement('div');

                let textColorClass = 'text-slate-400'; // Default color for logs
                if (type === 'error') {
                    textColorClass = 'text-red-400';
                } else if (type === 'warn') {
                    textColorClass = 'text-yellow-400';
                } else if (type === 'success') {
                    textColorClass = 'text-green-400';
                } else if (type === 'info') {
                     textColorClass = 'text-blue-400';
                } else if (type === 'loading') {
                    textColorClass = 'text-yellow-500 animate-pulse'; // Animation for loading
                }

                // Sanitize the message to prevent basic HTML injection
                const textNode = document.createTextNode(message);
                const spanMessage = document.createElement('span');
                spanMessage.className = textColorClass;
                spanMessage.appendChild(textNode);

                messageElement.innerHTML = `<span class="font-mono text-xs text-slate-500 mr-2">[${timestamp}]</span> ${emoji} `;
                messageElement.appendChild(spanMessage);

                this.outputArea.appendChild(messageElement);
                this.outputArea.scrollTop = this.outputArea.scrollHeight; // Scroll to the bottom
            },

            /**
             * Callback to capture Skulpt output (print).
             * @param {string} text - The text printed by the Python code.
             */
            skulptOutput(text) {
                // Skulpt might add an extra newline, remove if it exists
                const cleanedText = text.endsWith('\n') ? text.slice(0, -1) : text;
                if (cleanedText) { // Only add if not empty
                     MultiLangExecutor.addToOutput(cleanedText, 'log', 'python');
                }
            },

             /**
             * Callback to capture Lua.js output (print).
             * Lua.js print sends arguments separately, we need to join them.
             * @param {...any} args - Arguments passed to print() in Lua.
             */
            luaOutput(...args) {
                 const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' ');
                 MultiLangExecutor.addToOutput(message, 'log', 'lua');
                 // Lua print usually adds a newline by default,
                 // but depending on Lua.js configuration, it might be necessary to add one here.
                 // For simplicity, we'll assume it already adds one or that newline
                 // is not strictly necessary for each individual print.
                 // If needed, add: MultiLangExecutor.addToOutput('', 'log', 'lua');
            },


            /**
             * Callback to read built-in modules (required by Skulpt).
             * @param {string} x - The name of the module to read.
             * @returns {string} The source code of the module.
             * @throws {string} If the module is not found.
             */
            builtinRead(x) {
                if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined) {
                    throw "File not found: '" + x + "'";
                }
                return Sk.builtinFiles["files"][x];
            },

            /**
             * Enables/disables buttons and shows/hides a loading indicator.
             * @param {boolean} isLoading - True if loading, False otherwise.
             */
            setLoadingState(isLoading) {
                this.runButton.disabled = isLoading;
                this.clearOutputButton.disabled = isLoading;
                this.languageSelect.disabled = isLoading; // Disable select during execution
                 if (isLoading) {
                     // Remove previous loading message if it exists
                     const lastChild = this.outputArea.lastChild;
                      if (lastChild && lastChild.textContent.includes("Executing code...") && lastChild.querySelector('.animate-pulse')) {
                         lastChild.remove();
                     }
                     this.addToOutput(`Executing ${this.currentLanguage} code...`, 'loading', this.currentLanguage);
                 } else {
                     // The loading message will be removed or replaced by the result (success/error)
                 }
            },

            /**
             * Executes the Python code entered in the editor.
             */
            runPythonCode() {
                const userCode = this.codeEditor.value;
                this.setLoadingState(true); // Activate loading state

                Sk.configure({
                    output: this.skulptOutput, // Redirect print() to our function
                    read: this.builtinRead,     // Function to import modules
                    __future__: Sk.python3 // Use Python 3 semantics
                });

                // Execute the code asynchronously with Skulpt
                const executionPromise = Sk.misceval.asyncToPromise(() => {
                    return Sk.importMainWithBody("<stdin>", false, userCode, true);
                });

                executionPromise.then(
                    (mod) => {
                        // Python code executed successfully
                        this.setLoadingState(false); // Deactivate loading state
                         // Remove loading message before adding success
                        const lastChild = this.outputArea.lastChild;
                         if (lastChild && lastChild.textContent.includes("Executing python code...") && lastChild.querySelector('.animate-pulse')) {
                             lastChild.remove();
                         }
                        this.addToOutput("Python execution completed.", 'success', 'python');
                    },
                    (err) => {
                        // Error during Python code execution
                        this.setLoadingState(false); // Deactivate loading state
                         // Remove loading message before adding error
                        const lastChild = this.outputArea.lastChild;
                         if (lastChild && lastChild.textContent.includes("Executing python code...") && lastChild.querySelector('.animate-pulse')) {
                             lastChild.remove();
                         }

                        this.addToOutput(`Skulpt Error: ${err.toString()}`, 'error', 'python');
                        // Display traceback if available
                        if (err.traceback) {
                            err.traceback.forEach((tb) => {
                                this.addToOutput(`  in ${tb.filename}, line ${tb.lineno}`, 'error');
                            });
                        }
                    }
                );
            },

            /**
             * Executes the Lua code entered in the editor.
             */
            runLuaCode() {
                const userCode = this.codeEditor.value;
                this.setLoadingState(true); // Activate loading state

                try {
                    // Initialize Lua state if not already done
                    if (!this.luaState) {
                         this.luaState = new Lua.State();
                         // Redirect Lua's print function to our addToOutput
                         // Lua.js print sends arguments separately, we need to handle them
                         this.luaState.execute(`
                            local original_print = print
                            print = function(...)
                                local args = {...}
                                -- Pass arguments to the JavaScript function
                                js.global.MultiLangExecutor.luaOutput(unpack(args))
                            end
                         `);
                         this.addToOutput("Lua interpreter initialized.", 'info', 'lua');
                    }

                    // Execute the Lua code. Note: Lua.js executes synchronously,
                    // which can freeze the UI for long-running code.
                    this.luaState.execute(userCode);

                    // Lua code executed successfully
                    this.setLoadingState(false); // Deactivate loading state
                     // Remove loading message before adding success
                    const lastChild = this.outputArea.lastChild;
                     if (lastChild && lastChild.textContent.includes("Executing lua code...") && lastChild.querySelector('.animate-pulse')) {
                         lastChild.remove();
                     }
                    this.addToOutput("Lua execution completed.", 'success', 'lua');

                } catch (err) {
                    // Error during Lua code execution
                    this.setLoadingState(false); // Deactivate loading state
                     // Remove loading message before adding error
                    const lastChild = this.outputArea.lastChild;
                     if (lastChild && lastChild.textContent.includes("Executing lua code...") && lastChild.querySelector('.animate-pulse')) {
                         lastChild.remove();
                     }
                    this.addToOutput(`Lua Error: ${err.message || err}`, 'error', 'lua');
                    // Lua.js may not provide detailed trace
